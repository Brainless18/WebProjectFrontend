<template>

  <article id="whiteboard-container" style="position: relative">

    <div
      ref="quill"
      id="quill-container"
      v-show="toolSelected.toLowerCase() === 'text'"
      :style="{
        'top': quillContainerTop + 'px',
        'left': quillContainerLeft + 'px',

      }"></div>

    <quill-toolbar  v-show="toolSelected.toLowerCase() === 'text'" />

    <div class="konva-wrapper">
      <whiteboard-color-picker/>
      <whiteboard-brush-tools/>
      <div tabindex="0" ref="konva" id="konva-container" :style="styles.cursorStyle"></div>
    </div>


  </article>
</template>

<script>
import Konva from 'konva';
import {reactive, onMounted, ref, computed} from 'vue';
import useCursorStyle from "./hooks/styles/useCursorStyle";
import {useWhiteboardStore} from "./store/whiteboard";
import {listeners, useWhiteboardEventListeners} from "./hooks/listeners/whiteboard";
import {useHistoryStore} from "./store/history";
import {bindHotkeys} from "./hooks/listeners/hotkeys";
import QuillToolbar from "./quill/QuillToolbar";
import {useQuillStore} from "./store/quill";
import {onWheel} from "./hooks/listeners/mouse/on-wheel";
import {useClipboard} from "./utils/clipboard";
import {removeSelected} from "./utils/transformer/selection";
import WhiteboardColorPicker from "./WhiteboardColorPicker";
import WhiteboardStrokePicker from "./components/WhiteboardStrokePicker";
import {onAlt} from "./hooks/listeners/modifier/on-alt";
import WhiteboardBrushTools from "./components/WhiteboardBrushTools";

export default {
  name: 'WhiteboardContainer',
  components: {WhiteboardBrushTools, WhiteboardColorPicker, QuillToolbar},
  setup(props, context) {

    const {states, stage, layer, tempLayer, toolSelected, lastMouseClickAbsPos} = useWhiteboardStore()
    const {onMouseDown, onMouseUp, onMouseMove, onToolChange, onEscPressed} = useWhiteboardEventListeners();
    const {record, undo, redo, history} = useHistoryStore();
    const {editorYPos, editorXPos, editor, quill, getToolbarHeight} = useQuillStore();
    const { copy, paste } = useClipboard();


    const konva = ref(null);

    onMounted(() => {
      Konva.dragButtons = [0, 1];
      stage.value = new Konva.Stage({
        container: 'konva-container',
        width: konva.value.clientWidth,
        height: konva.value.clientHeight,
        // draggable: true,
      });
      layer.value = new Konva.Layer();
      tempLayer.value = new Konva.Layer();
      // add the layer to the stage
      stage.value.add(layer.value);
      stage.value.add(tempLayer.value);
      stage.value.on('mousedown touchstart', onMouseDown);
      stage.value.on('mouseup touchend', onMouseUp);
      stage.value.on('mousemove touchmove', onMouseMove);
      stage.value.on('wheel', onWheel);
      stage.value.on('contextmenu', (event) => event.evt.preventDefault());
      record();

      // const line = new Konva.Line({
      //   points: [50, 50, 50, 250],
      //   stroke: 'red',
      //   strokeWidth: 10,
      //   lineCap: 'round',
      //   lineJoin: 'round',
      //   tension: 1,
      // });
      // line.cache()
      // console.log('a');
      //
      // line.filters([Konva.Filters.Blur]);
      // line.blurRadius(180);
      // layer.value.add(line);
      // layer.value.draw();

      // add esc event listener
      bindHotkeys(konva.value, {
        'Escape': onEscPressed,
        'Control+z': undo,
        'Control+Z': undo,
        'Control+Shift+Z': redo,
        'Control+v': paste,
        'Control+V': paste,
        'Control+c': copy,
        'Control+C': copy,
        'Delete': removeSelected,
        't': () => onToolChange('text'), // select text tool
        'v': () => onToolChange('Move'),
        'r': () => onToolChange('Rectangle'),
        'o': () => onToolChange('Circle'),
        'p': () => onToolChange('Pencil'),
        'l': () => onToolChange('Line'),
      });
    });

    const {cursor} = useCursorStyle();

    return {
      quill,
      states,
      toolSelected,
      konva,
      styles: reactive({
        cursorStyle: {cursor},
      }),
      quillContainerTop: computed(() => lastMouseClickAbsPos.yPos + getToolbarHeight()),
      quillContainerLeft: computed(() => lastMouseClickAbsPos.xPos + 5),
      history, // TODO: remove this, debugging only
    }
  },
  props: {},

}
</script>

<style scoped lang="scss">
#konva-container {
  border: black solid;
  height: 80vh;
}

#quill-container{
  //width: fit-content;
  min-width: 50px;
  position: absolute;
  z-index: 100;
  //min-height: 20px;
  height: auto;
}





</style>
